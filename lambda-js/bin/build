#!/usr/bin/env bash

set -eu

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"

if compgen -G "${env_dir}/*" > /dev/null; then
  for var in ${env_dir}/*; do
    declare "$(basename ${var})=$(<${var})"
  done
fi

######################
# install runtime
######################
runtime_layer=$layers_dir/runtime
ric_version="1.0.0"

echo ""
echo "[Lambda Runtime Interface Client for Node.js]"

if [ -f ${runtime_layer}.toml ] && [ "$(cat "${runtime_layer}.toml" | yj -t | jq .metadata.version -r)" == "${ric_version}" ]; then
  echo "Using cached version: ${ric_version}"
  touch ${runtime_layer}.toml
else
  echo "Installing version: ${ric_version}"
  mkdir -p $runtime_layer/env
  npm install --prefix $runtime_layer aws-lambda-ric@${ric_version} --save

  echo "$runtime_layer/node_modules" > $runtime_layer/env/NODE_PATH

  cat <<TOML > ${runtime_layer}.toml
launch = true
cache = true

[metadata]
version = "${ric_version}"
TOML
fi

######################
# install emulator
######################

# The versions from https://github.com/aws/aws-lambda-base-images/tree/nodejs12.x
base_sha="7411b1a0ea52fd1cdca24bb089b653c646946da8"
layer_sha="c7af6df05a4deb705597f4ede97ec97644daad5311ae81fce733bbf167fe2ddd"
rie_layer=$layers_dir/rie

echo ""
echo "[AWS Lambda Emulator]"
if [ -f ${rie_layer}.toml ] && [ "$(cat "${rie_layer}.toml" | yj -t | jq .metadata.base_sha -r)" == "${base_sha}" ]; then
  echo "Using cached version: ${base_sha}"
  touch ${rie_layer}.toml
else
  mkdir -p $rie_layer
  echo "Installing version: ${base_sha}"
  curl -sL --retry 3 \
    "https://github.com/aws/aws-lambda-base-images/raw/${base_sha}/${layer_sha}.tar.xz" \
    | tar xJ -C $rie_layer/
  cat <<TOML > ${rie_layer}.toml
launch = true
cache = true

[metadata]
base_sha = "${base_sha}"
layer_sha = "${layer_sha}"
TOML
fi

# TODO store the shas in metadata and cache

######################
# install entrypoint
######################
entrypoint_layer=$layers_dir/entrypoint
mkdir -p $entrypoint_layer/bin

echo ""
echo "[AWS Lambda Launch Config]"

echo "Installing entrypoint script"
cat <<EOF > ${entrypoint_layer}/bin/lambda-entrypoint
#!/bin/bash

RUNTIME_ENTRYPOINT="./bootstrap"
if [ -z "\${AWS_LAMBDA_RUNTIME_API}" ]; then
  exec ${rie_layer}/usr/local/bin/aws-lambda-rie \$RUNTIME_ENTRYPOINT
else
  exec \$RUNTIME_ENTRYPOINT
fi
EOF
chmod +x ${entrypoint_layer}/bin/lambda-entrypoint
echo "launch = true" > ${entrypoint_layer}.toml

cat <<EOF > ${layers_dir}/launch.toml
[[processes]]
type = "web"
command = "lambda-entrypoint"

[[processes]]
type = "bash"
command = "/bin/bash"
EOF

######################
# install bootstrap
######################
echo "Installing bootstrap script"
cat <<EOF > bootstrap
#!/bin/bash

if [ -n "\$AWS_LAMBDA_FUNCTION_MEMORY_SIZE" ];
then
  new_space=\$(expr \$AWS_LAMBDA_FUNCTION_MEMORY_SIZE / 10)
  semi_space=\$(expr \$new_space / 2)
  old_space=\$(expr \$AWS_LAMBDA_FUNCTION_MEMORY_SIZE - \$new_space)
  MEMORY_ARGS=(
    "--node-arg=--max-semi-space-size=\$semi_space"
    "--node-arg=--max-old-space-size=\$old_space"
  )
fi

export AWS_EXECUTION_ENV=AWS_Lambda_nodejs12.x

NODE_ARGS=(
    --node-arg=--expose-gc
    --node-arg=--max-http-header-size=81920
    "\${MEMORY_ARGS[@]}"
    )

if [ -z "\$AWS_LAMBDA_EXEC_WRAPPER" ]; then
  exec npx aws-lambda-ric app.handler
else
  wrapper="\$AWS_LAMBDA_EXEC_WRAPPER"
  if [ ! -f "\$wrapper" ]; then
    echo "\$wrapper: does not exist"
    exit 127
  fi
  if [ ! -x "\$wrapper" ]; then
    echo "\$wrapper: is not an executable"
    exit 126
  fi
  exec -- "\$wrapper" npx aws-lambda-ric app.handler
fi
EOF
chmod +x bootstrap